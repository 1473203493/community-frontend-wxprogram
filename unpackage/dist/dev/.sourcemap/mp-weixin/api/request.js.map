{"version":3,"file":"request.js","sources":["api/request.js"],"sourcesContent":["// 封装请求方法\r\nconst request = (options) => {\r\n    // 获取基础URL\r\n    const baseURL = getBaseURL();\r\n\r\n    // 获取存储的Token\r\n    const token = getToken();\r\n\r\n    // 默认请求头\r\n    const header = options.header || {};\r\n\r\n    // 如果有token，把token放入到请求头里\r\n    if (token) {\r\n        header['Authorization'] = token;\r\n    }\r\n\r\n    // 默认配置\r\n    const config = {\r\n        retry: options.retry || 3, // 最大重试次数\r\n        retryDelay: options.retryDelay || 1000, // 重试延迟（毫秒）\r\n        timeout: options.timeout || 10000, // 超时时间（毫秒）\r\n        ...options\r\n    };\r\n\r\n    // 返回Promise\r\n    return new Promise((resolve, reject) => {\r\n        // 检查网络状态\r\n        checkNetworkStatus().then(isConnected => {\r\n            if (!isConnected) {\r\n                uni.showToast({ title: '网络连接失败，请检查网络设置', icon: 'none' });\r\n                reject(new Error('网络连接失败'));\r\n                return;\r\n            }\r\n\r\n            // 发送请求\r\n            sendRequest(config, 0, resolve, reject);\r\n        }).catch(err => {\r\n            uni.showToast({ title: '网络检查失败', icon: 'none' });\r\n            reject(err);\r\n        });\r\n    });\r\n};\r\n\r\n// 发送请求（支持重试）\r\nconst sendRequest = (options, retryCount, resolve, reject) => {\r\n    const baseURL = getBaseURL();\r\n    const token = getToken();\r\n    const header = options.header || {};\r\n    \r\n    if (token) {\r\n        header['Authorization'] = token;\r\n    }\r\n\r\n    uni.request({\r\n        url: baseURL + options.url,\r\n        method: options.method || 'GET',\r\n        data: options.data || {},\r\n        header,\r\n        timeout: options.timeout,\r\n        success: (res) => {\r\n            console.log(\"【完整响应返回】\", res);\r\n            // 检查HTTP状态码\r\n            if (res.statusCode >= 200 && res.statusCode < 300) {\r\n                // 检查业务状态码\r\n                if (res.data.code === 200) {\r\n                    resolve({\r\n                        success: true,\r\n                        code: res.data.code,\r\n                        data: res.data.data,\r\n                        message: res.data.message\r\n                    });\r\n                } else if (res.data.code === 401) {\r\n                    // 未授权，清除token并跳转到登录页\r\n                    uni.removeStorageSync('token');\r\n                    uni.removeStorageSync('userInfo');\r\n                    uni.showToast({ title: '登录已过期，请重新登录', icon: 'none' });\r\n                    uni.navigateTo({ url: '/pages/student/auth/login' });\r\n                    resolve({\r\n                        success: false,\r\n                        code: res.data.code,\r\n                        data: null,\r\n                        message: res.data.message || '登录已过期'\r\n                    });\r\n                } else {\r\n                    // 其他业务错误\r\n                    resolve({\r\n                        success: false,\r\n                        code: res.data.code,\r\n                        data: null,\r\n                        message: res.data.message || '请求失败'\r\n                    });\r\n                }\r\n            } else {\r\n                // HTTP错误\r\n                let errorMsg = '请求失败';\r\n                switch (res.statusCode) {\r\n                    case 400: errorMsg = '请求参数错误'; break;\r\n                    case 401: errorMsg = '未授权，请重新登录'; break;\r\n                    case 403: errorMsg = '拒绝访问'; break;\r\n                    case 404: errorMsg = '请求的资源不存在'; break;\r\n                    case 500: errorMsg = '服务器内部错误'; break;\r\n                    case 502: errorMsg = '网关错误'; break;\r\n                    case 503: errorMsg = '服务不可用'; break;\r\n                    case 504: errorMsg = '网关超时'; break;\r\n                    default: errorMsg = `请求失败(${res.statusCode})`;\r\n                }\r\n                resolve({\r\n                    success: false,\r\n                    code: res.statusCode,\r\n                    data: null,\r\n                    message: errorMsg\r\n                });\r\n            }\r\n        },\r\n        fail: (err) => {\r\n            // 请求失败，检查是否需要重试\r\n            if (retryCount < options.retry) {\r\n                retryCount++;\r\n                setTimeout(() => {\r\n                    sendRequest(options, retryCount, resolve, reject);\r\n                }, options.retryDelay);\r\n            } else {\r\n                // 超过最大重试次数\r\n                resolve({\r\n                    success: false,\r\n                    code: -1,\r\n                    data: null,\r\n                    message: '网络请求失败，请稍后重试'\r\n                });\r\n            }\r\n        }\r\n    });\r\n};\r\n\r\n// 处理HTTP错误（已整合到sendRequest中，保留该函数以防其他地方调用）\r\nconst handleHttpError = (statusCode, options, retryCount, resolve, reject) => {\r\n    let errorMsg = '请求失败';\r\n    \r\n    switch (statusCode) {\r\n        case 400:\r\n            errorMsg = '请求参数错误';\r\n            break;\r\n        case 401:\r\n            errorMsg = '未授权，请重新登录';\r\n            uni.removeStorageSync('token');\r\n            uni.removeStorageSync('userInfo');\r\n            uni.navigateTo({ url: '/pages/student/auth/login' });\r\n            break;\r\n        case 403:\r\n            errorMsg = '拒绝访问';\r\n            break;\r\n        case 404:\r\n            errorMsg = '请求的资源不存在';\r\n            break;\r\n        case 500:\r\n            errorMsg = '服务器内部错误';\r\n            break;\r\n        case 502:\r\n            errorMsg = '网关错误';\r\n            break;\r\n        case 503:\r\n            errorMsg = '服务不可用';\r\n            break;\r\n        case 504:\r\n            errorMsg = '网关超时';\r\n            break;\r\n        default:\r\n            errorMsg = `请求失败(${statusCode})`;\r\n    }\r\n    \r\n    // 服务器错误可以重试\r\n    if (statusCode >= 500 && statusCode < 600 && retryCount < options.retry) {\r\n        retryCount++;\r\n        setTimeout(() => {\r\n            sendRequest(options, retryCount, resolve, reject);\r\n        }, options.retryDelay);\r\n    } else {\r\n        resolve({\r\n            success: false,\r\n            code: statusCode,\r\n            data: null,\r\n            message: errorMsg\r\n        });\r\n    }\r\n};\r\n\r\n// 检查网络状态\r\nconst checkNetworkStatus = () => {\r\n    return new Promise((resolve) => {\r\n        uni.getNetworkType({\r\n            success: (res) => {\r\n                resolve(res.networkType !== 'none');\r\n            },\r\n            fail: () => {\r\n                resolve(false);\r\n            }\r\n        });\r\n    });\r\n};\r\n\r\n\r\n// 获取基础URL\r\nconst getBaseURL = () => {\r\n    // 根据不同环境返回不同的基础URL\r\n    // 这里可以根据实际项目配置进行修改\r\n    let platform = 'other';\r\n    \r\n    try {\r\n        // 使用新的API获取环境信息\r\n        const systemInfo = uni.getSystemInfoSync();\r\n        platform = systemInfo.platform;\r\n    } catch (error) {\r\n        console.error('获取系统信息失败:', error);\r\n    }\r\n    \r\n    // H5环境\r\n    if (platform === 'web') {\r\n        return '';\r\n    }\r\n    \r\n    // 微信小程序环境\r\n    if (platform === 'devtools' || platform === 'ios' || platform === 'android') {\r\n        return 'http://localhost:8089'; //开发环境使用HTTP，实际环境应改为HTTPS\r\n    }\r\n\r\n    // 默认返回也是本地后端，实际项目中应根据后端接口地址设置\r\n    return 'http://localhost:8089';\r\n};\r\n\r\n\r\n\r\n// 获取存储的Token\r\nconst getToken = () => {\r\n    try {\r\n        // 从本地存储中获取token\r\n        const token = uni.getStorageSync('token');\r\n        return token || '';\r\n    } catch (error) {\r\n        console.error('获取token失败:', error);\r\n        return '';\r\n    }\r\n};\r\n\r\n// 导出request方法供其他模块使用\r\nexport default request;\r\n\r\n// 导出快捷方法\r\nexport const get = (url, params, options = {}) => {\r\n    return request({\r\n        url,\r\n        method: 'GET',\r\n        data: params,\r\n        ...options\r\n    });\r\n};\r\n\r\nexport const post = (url, data, options = {}) => {\r\n    return request({\r\n        url,\r\n        method: 'POST',\r\n        data,\r\n        ...options\r\n    });\r\n};\r\n\r\nexport const put = (url, data, options = {}) => {\r\n    return request({\r\n        url,\r\n        method: 'PUT',\r\n        data,\r\n        ...options\r\n    });\r\n};\r\n\r\nexport const del = (url, params, options = {}) => {\r\n    return request({\r\n        url,\r\n        method: 'DELETE',\r\n        data: params,\r\n        ...options\r\n    });\r\n};\r\n\r\n// 将快捷方法挂载到request对象上，方便使用\r\nrequest.get = get;\r\nrequest.post = post;\r\nrequest.put = put;\r\nrequest.delete = del;\r\n"],"names":["uni"],"mappings":";;AACK,MAAC,UAAU,CAAC,YAAY;AAET,aAAa;AAG7B,QAAM,QAAQ;AAGd,QAAM,SAAS,QAAQ,UAAU;AAGjC,MAAI,OAAO;AACP,WAAO,eAAe,IAAI;AAAA,EAC7B;AAGD,QAAM,SAAS;AAAA,IACX,OAAO,QAAQ,SAAS;AAAA;AAAA,IACxB,YAAY,QAAQ,cAAc;AAAA;AAAA,IAClC,SAAS,QAAQ,WAAW;AAAA;AAAA,IAC5B,GAAG;AAAA,EACX;AAGI,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AAEpC,uBAAoB,EAAC,KAAK,iBAAe;AACrC,UAAI,CAAC,aAAa;AACdA,sBAAG,MAAC,UAAU,EAAE,OAAO,kBAAkB,MAAM,OAAM,CAAE;AACvD,eAAO,IAAI,MAAM,QAAQ,CAAC;AAC1B;AAAA,MACH;AAGD,kBAAY,QAAQ,GAAG,OAAe;AAAA,IAClD,CAAS,EAAE,MAAM,SAAO;AACZA,oBAAG,MAAC,UAAU,EAAE,OAAO,UAAU,MAAM,OAAM,CAAE;AAC/C,aAAO,GAAG;AAAA,IACtB,CAAS;AAAA,EACT,CAAK;AACL;AAGA,MAAM,cAAc,CAAC,SAAS,YAAY,SAAS,WAAW;AAC1D,QAAM,UAAU;AAChB,QAAM,QAAQ;AACd,QAAM,SAAS,QAAQ,UAAU;AAEjC,MAAI,OAAO;AACP,WAAO,eAAe,IAAI;AAAA,EAC7B;AAEDA,gBAAAA,MAAI,QAAQ;AAAA,IACR,KAAK,UAAU,QAAQ;AAAA,IACvB,QAAQ,QAAQ,UAAU;AAAA,IAC1B,MAAM,QAAQ,QAAQ,CAAE;AAAA,IACxB;AAAA,IACA,SAAS,QAAQ;AAAA,IACjB,SAAS,CAAC,QAAQ;AACdA,oBAAA,MAAA,MAAA,OAAA,wBAAY,YAAY,GAAG;AAE3B,UAAI,IAAI,cAAc,OAAO,IAAI,aAAa,KAAK;AAE/C,YAAI,IAAI,KAAK,SAAS,KAAK;AACvB,kBAAQ;AAAA,YACJ,SAAS;AAAA,YACT,MAAM,IAAI,KAAK;AAAA,YACf,MAAM,IAAI,KAAK;AAAA,YACf,SAAS,IAAI,KAAK;AAAA,UAC1C,CAAqB;AAAA,QACJ,WAAU,IAAI,KAAK,SAAS,KAAK;AAE9BA,8BAAI,kBAAkB,OAAO;AAC7BA,8BAAI,kBAAkB,UAAU;AAChCA,wBAAG,MAAC,UAAU,EAAE,OAAO,eAAe,MAAM,OAAM,CAAE;AACpDA,wBAAAA,MAAI,WAAW,EAAE,KAAK,4BAA6B,CAAA;AACnD,kBAAQ;AAAA,YACJ,SAAS;AAAA,YACT,MAAM,IAAI,KAAK;AAAA,YACf,MAAM;AAAA,YACN,SAAS,IAAI,KAAK,WAAW;AAAA,UACrD,CAAqB;AAAA,QACrB,OAAuB;AAEH,kBAAQ;AAAA,YACJ,SAAS;AAAA,YACT,MAAM,IAAI,KAAK;AAAA,YACf,MAAM;AAAA,YACN,SAAS,IAAI,KAAK,WAAW;AAAA,UACrD,CAAqB;AAAA,QACJ;AAAA,MACjB,OAAmB;AAEH,YAAI,WAAW;AACf,gBAAQ,IAAI,YAAU;AAAA,UAClB,KAAK;AAAK,uBAAW;AAAU;AAAA,UAC/B,KAAK;AAAK,uBAAW;AAAa;AAAA,UAClC,KAAK;AAAK,uBAAW;AAAQ;AAAA,UAC7B,KAAK;AAAK,uBAAW;AAAY;AAAA,UACjC,KAAK;AAAK,uBAAW;AAAW;AAAA,UAChC,KAAK;AAAK,uBAAW;AAAQ;AAAA,UAC7B,KAAK;AAAK,uBAAW;AAAS;AAAA,UAC9B,KAAK;AAAK,uBAAW;AAAQ;AAAA,UAC7B;AAAS,uBAAW,QAAQ,IAAI,UAAU;AAAA,QAC7C;AACD,gBAAQ;AAAA,UACJ,SAAS;AAAA,UACT,MAAM,IAAI;AAAA,UACV,MAAM;AAAA,UACN,SAAS;AAAA,QAC7B,CAAiB;AAAA,MACJ;AAAA,IACJ;AAAA,IACD,MAAM,CAAC,QAAQ;AAEX,UAAI,aAAa,QAAQ,OAAO;AAC5B;AACA,mBAAW,MAAM;AACb,sBAAY,SAAS,YAAY,OAAe;AAAA,QACpE,GAAmB,QAAQ,UAAU;AAAA,MACrC,OAAmB;AAEH,gBAAQ;AAAA,UACJ,SAAS;AAAA,UACT,MAAM;AAAA,UACN,MAAM;AAAA,UACN,SAAS;AAAA,QAC7B,CAAiB;AAAA,MACJ;AAAA,IACJ;AAAA,EACT,CAAK;AACL;AAuDA,MAAM,qBAAqB,MAAM;AAC7B,SAAO,IAAI,QAAQ,CAAC,YAAY;AAC5BA,kBAAAA,MAAI,eAAe;AAAA,MACf,SAAS,CAAC,QAAQ;AACd,gBAAQ,IAAI,gBAAgB,MAAM;AAAA,MACrC;AAAA,MACD,MAAM,MAAM;AACR,gBAAQ,KAAK;AAAA,MAChB;AAAA,IACb,CAAS;AAAA,EACT,CAAK;AACL;AAIA,MAAM,aAAa,MAAM;AAGrB,MAAI,WAAW;AAEf,MAAI;AAEA,UAAM,aAAaA,oBAAI;AACvB,eAAW,WAAW;AAAA,EACzB,SAAQ,OAAO;AACZA,kBAAA,MAAA,MAAA,SAAA,yBAAc,aAAa,KAAK;AAAA,EACnC;AAGD,MAAI,aAAa,OAAO;AACpB,WAAO;AAAA,EACV;AAGD,MAAI,aAAa,cAAc,aAAa,SAAS,aAAa,WAAW;AACzE,WAAO;AAAA,EACV;AAGD,SAAO;AACX;AAKA,MAAM,WAAW,MAAM;AACnB,MAAI;AAEA,UAAM,QAAQA,cAAAA,MAAI,eAAe,OAAO;AACxC,WAAO,SAAS;AAAA,EACnB,SAAQ,OAAO;AACZA,kBAAA,MAAA,MAAA,SAAA,yBAAc,cAAc,KAAK;AACjC,WAAO;AAAA,EACV;AACL;AAMO,MAAM,MAAM,CAAC,KAAK,QAAQ,UAAU,CAAA,MAAO;AAC9C,SAAO,QAAQ;AAAA,IACX;AAAA,IACA,QAAQ;AAAA,IACR,MAAM;AAAA,IACN,GAAG;AAAA,EACX,CAAK;AACL;AAEO,MAAM,OAAO,CAAC,KAAK,MAAM,UAAU,CAAA,MAAO;AAC7C,SAAO,QAAQ;AAAA,IACX;AAAA,IACA,QAAQ;AAAA,IACR;AAAA,IACA,GAAG;AAAA,EACX,CAAK;AACL;AAEO,MAAM,MAAM,CAAC,KAAK,MAAM,UAAU,CAAA,MAAO;AAC5C,SAAO,QAAQ;AAAA,IACX;AAAA,IACA,QAAQ;AAAA,IACR;AAAA,IACA,GAAG;AAAA,EACX,CAAK;AACL;AAEO,MAAM,MAAM,CAAC,KAAK,QAAQ,UAAU,CAAA,MAAO;AAC9C,SAAO,QAAQ;AAAA,IACX;AAAA,IACA,QAAQ;AAAA,IACR,MAAM;AAAA,IACN,GAAG;AAAA,EACX,CAAK;AACL;AAGA,QAAQ,MAAM;AACd,QAAQ,OAAO;AACf,QAAQ,MAAM;AACd,QAAQ,SAAS;;"}